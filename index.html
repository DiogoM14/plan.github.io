<!doctype html>
<html lang="pt-PT">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>Aplica√ß√£o Powerbuilder</title>

    <!-- PWA / iOS Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Powerbuilder" />
    <meta name="theme-color" content="#ffffff" />

    <!-- PWA Icon -->
    <link
      rel="apple-touch-icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%234f46e5%22 rx=%2220%22 ry=%2220%22/><text y=%22.9em%22 x=%22.1em%22 font-size=%2290%22>üí™</text></svg>"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%234f46e5%22 rx=%2220%22 ry=%2220%22/><text y=%22.9em%22 x=%22.1em%22 font-size=%2290%22>üí™</text></svg>"
    />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc; /* Slate-50 */
        -webkit-tap-highlight-color: transparent;
        padding-bottom: 100px;
        padding-top: env(safe-area-inset-top);
        color: #1e293b;
      }

      /* Animations */
      .page-content {
        display: none;
        animation: fadeSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .page-content.active {
        display: block;
      }
      @keyframes fadeSlideUp {
        from {
          opacity: 0;
          transform: translateY(15px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .card-hover {
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      }
      .card-hover:active {
        transform: scale(0.97);
      }

      .app-card {
        background: white;
        border-radius: 20px;
        box-shadow:
          0 10px 25px -5px rgba(0, 0, 0, 0.05),
          0 8px 10px -6px rgba(0, 0, 0, 0.01);
        margin-bottom: 16px;
        overflow: hidden;
        border: 1px solid rgba(241, 245, 249, 1);
      }

      .gym-input {
        background: #f1f5f9;
        border: 2px solid transparent;
        border-radius: 12px;
        text-align: center;
        font-size: 16px;
        transition: all 0.2s;
        font-weight: 600;
        color: #334155;
      }
      .gym-input:focus {
        border-color: #6366f1;
        background: white;
        outline: none;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      }

      .nav-item {
        color: #94a3b8;
        transition: all 0.3s ease;
        position: relative;
      }
      .nav-item.active {
        color: #4f46e5;
        transform: translateY(-2px);
      }
      .nav-item.active::after {
        content: "";
        position: absolute;
        bottom: -8px;
        width: 4px;
        height: 4px;
        background: #4f46e5;
        border-radius: 50%;
      }
      .nav-icon {
        font-size: 1.6rem;
        margin-bottom: 2px;
        transition: transform 0.2s;
      }
      .nav-item:active .nav-icon {
        transform: scale(0.9);
      }

      #timer-modal,
      #exercise-modal,
      #edit-plan-modal {
        backdrop-filter: blur(8px);
        background-color: rgba(0, 0, 0, 0.2);
      }

      .ai-pulse {
        animation: pulse-purple 2s infinite;
      }
      @keyframes pulse-purple {
        0% {
          box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4);
        }
        70% {
          box-shadow: 0 0 0 8px rgba(139, 92, 246, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(139, 92, 246, 0);
        }
      }

      .plan-active-badge {
        background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
        color: #3730a3;
        font-size: 0.65rem;
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 800;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        box-shadow: 0 2px 5px rgba(79, 70, 229, 0.15);
      }

      .prog-badge {
        font-size: 0.65rem;
        font-weight: 800;
        text-transform: uppercase;
        padding: 4px 8px;
        border-radius: 6px;
      }
      .prog-up {
        background: #dcfce7;
        color: #15803d;
      }
      .prog-stall {
        background: #fef9c3;
        color: #a16207;
      }
      .prog-deload {
        background: #fee2e2;
        color: #b91c1c;
      }

      /* Gradient Text */
      .text-gradient {
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-image: linear-gradient(135deg, #4f46e5, #8b5cf6);
      }
    </style>
  </head>
  <body class="text-slate-800">
    <!-- Top Header (Glassmorphism) -->
    <header
      class="fixed top-0 w-full bg-white/80 backdrop-blur-lg border-b border-slate-100 z-40 px-5 py-4 flex justify-between items-center pt-[calc(env(safe-area-inset-top)+12px)] transition-all"
    >
      <h1 class="text-xl font-extrabold tracking-tight flex items-center gap-2">
        <span class="text-gradient">Powerbuilder</span>
        <span
          class="text-[10px] bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full font-bold tracking-wider border border-indigo-200"
          >IA</span
        >
      </h1>
      <button
        id="timer-btn"
        class="bg-slate-100 text-slate-600 px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 hover:bg-slate-200 transition-colors shadow-sm"
      >
        ‚è±Ô∏è <span id="timer-display">Descanso</span>
      </button>
    </header>

    <!-- Main Content Container -->
    <main class="container mx-auto max-w-lg px-5 pt-28">
      <!-- ======================= -->
      <!-- == DASHBOARD (IN√çCIO) == -->
      <!-- ======================= -->
      <section id="dashboard" class="page-content active">
        <!-- Welcome Banner -->
        <div
          class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-3xl p-6 text-white mb-8 shadow-xl shadow-indigo-200 relative overflow-hidden card-hover"
        >
          <div class="absolute top-0 right-0 opacity-10 text-[10rem] -mr-8 -mt-8 rotate-12">üöÄ</div>
          <div class="relative z-10">
            <h2 class="text-3xl font-black mb-1">Vamos a isto!</h2>
            <p class="text-indigo-100 text-sm font-medium mb-5 opacity-90" id="active-plan-name">A carregar plano...</p>
            <div class="flex gap-2">
              <div class="bg-white/20 backdrop-blur-md px-3 py-1.5 rounded-lg text-xs font-bold border border-white/10">
                Fase de Ganho
              </div>
              <button
                onclick="switchTab('plans')"
                class="bg-white text-indigo-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-md hover:bg-indigo-50 transition-colors"
              >
                Trocar Plano
              </button>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 px-1">Treino de Hoje</h3>
        <div id="dashboard-workouts-grid" class="grid grid-cols-2 gap-4 mb-8">
          <!-- Injected via JS -->
        </div>

        <!-- Mini Stats -->
        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 px-1">Resumo Di√°rio</h3>
        <div class="app-card p-5 flex justify-between items-center bg-white">
          <div class="text-center">
            <div class="text-xs text-slate-400 font-bold uppercase mb-1">Calorias</div>
            <div class="text-xl font-black text-slate-800">2,750</div>
          </div>
          <div class="h-10 w-px bg-slate-100"></div>
          <div class="text-center">
            <div class="text-xs text-slate-400 font-bold uppercase mb-1">Prote√≠na</div>
            <div class="text-xl font-black text-indigo-600">160g</div>
          </div>
          <div class="h-10 w-px bg-slate-100"></div>
          <div class="text-center">
            <div class="text-xs text-slate-400 font-bold uppercase mb-1">Deload</div>
            <div class="text-xl font-black text-slate-800">2 Sem</div>
          </div>
        </div>
      </section>

      <!-- ======================= -->
      <!-- == WORKOUT LOGGER (DI√ÅRIO) == -->
      <!-- ======================= -->
      <section id="log" class="page-content">
        <div id="active-workout-header" class="mb-6">
          <h2 class="text-3xl font-black text-slate-800 mb-1" id="workout-title">Selecione um Treino</h2>
          <p class="text-sm text-slate-500 font-medium" id="workout-subtitle">V√° ao painel principal para come√ßar</p>
        </div>

        <div
          id="ai-coach-banner"
          class="hidden mb-6 bg-gradient-to-r from-purple-50 to-indigo-50 border border-indigo-100 rounded-2xl p-4 flex items-center justify-between shadow-sm"
        >
          <div class="flex items-center gap-3">
            <div class="bg-white p-2 rounded-full shadow-sm text-xl">‚ú®</div>
            <div>
              <h4 class="font-bold text-indigo-900 text-sm">Coach IA</h4>
              <p class="text-xs text-indigo-600 font-medium">Recomenda√ß√µes prontas.</p>
            </div>
          </div>
          <button
            onclick="applyAISuggestions()"
            class="bg-indigo-600 text-white text-xs font-bold px-4 py-2.5 rounded-xl shadow-lg shadow-indigo-200 active:scale-95 transition-transform"
          >
            Aplicar
          </button>
        </div>

        <div id="workout-exercises" class="space-y-5">
          <div class="text-center py-12">
            <div class="text-6xl mb-4 opacity-20">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
            <p class="text-slate-400 font-medium">Nenhum treino ativo.</p>
            <button onclick="switchTab('dashboard')" class="text-indigo-600 font-bold mt-3 hover:underline">
              Voltar ao In√≠cio
            </button>
          </div>
        </div>
      </section>

      <!-- ======================= -->
      <!-- == PLANS & CUSTOMIZATION (PLANOS) == -->
      <!-- ======================= -->
      <section id="plans" class="page-content">
        <div class="flex justify-between items-center mb-8">
          <h2 class="text-2xl font-black text-slate-800">Meus Planos</h2>
          <button
            onclick="createNewPlan()"
            class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-transform flex items-center gap-2"
          >
            <span>+</span> Novo
          </button>
        </div>

        <div id="plans-list" class="space-y-4">
          <!-- Plans injected here -->
        </div>
      </section>

      <!-- ======================= -->
      <!-- == NUTRITION (DIETA) == -->
      <!-- ======================= -->
      <section id="nutrition" class="page-content">
        <h2 class="text-2xl font-black text-slate-800 mb-6">Nutri√ß√£o</h2>
        <div class="app-card p-8 flex flex-col items-center bg-white">
          <div class="relative h-56 w-56 mb-6">
            <canvas id="nutritionChart"></canvas>
            <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
              <span class="text-4xl font-black text-slate-800 tracking-tighter">2750</span>
              <span class="text-xs text-slate-400 font-bold tracking-widest uppercase">Kcal</span>
            </div>
          </div>
          <div class="grid grid-cols-3 gap-4 w-full text-center">
            <div class="bg-blue-50 p-3 rounded-2xl border border-blue-100">
              <div class="text-blue-600 font-black text-lg">160g</div>
              <div class="text-[10px] text-blue-400 font-bold uppercase tracking-wider">Prot</div>
            </div>
            <div class="bg-yellow-50 p-3 rounded-2xl border border-yellow-100">
              <div class="text-yellow-600 font-black text-lg">350g</div>
              <div class="text-[10px] text-yellow-500 font-bold uppercase tracking-wider">Hidr</div>
            </div>
            <div class="bg-red-50 p-3 rounded-2xl border border-red-100">
              <div class="text-red-600 font-black text-lg">70g</div>
              <div class="text-[10px] text-red-400 font-bold uppercase tracking-wider">Gord</div>
            </div>
          </div>
        </div>
      </section>

      <!-- ======================= -->
      <!-- == PROGRESSION (PROGRESSO) == -->
      <!-- ======================= -->
      <section id="progression" class="page-content">
        <h2 class="text-2xl font-black text-slate-800 mb-2">Evolu√ß√£o</h2>
        <p class="text-slate-500 text-sm mb-8 font-medium">An√°lise inteligente da tua for√ßa.</p>

        <!-- 1. Main Lifts Chart -->
        <div class="app-card p-5 mb-8">
          <div class="flex justify-between items-center mb-6">
            <h3 class="font-bold text-slate-800 flex items-center gap-2">üìà Tend√™ncia de For√ßa</h3>
            <span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded-md">1RM Estimado</span>
          </div>
          <div class="h-64 w-full">
            <canvas id="progressionChart"></canvas>
          </div>
        </div>

        <!-- 2. Next Workout Targets -->
        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 px-1">Metas da Pr√≥xima Sess√£o</h3>
        <div id="next-targets-list" class="space-y-4 mb-8">
          <div
            class="text-center py-8 text-slate-400 text-sm italic bg-white rounded-2xl border border-dashed border-slate-200"
          >
            Regista treinos para gerar metas inteligentes.
          </div>
        </div>

        <!-- 3. Stall Watch -->
        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 px-1">Alerta de Estagna√ß√£o</h3>
        <div id="stall-watch-list" class="space-y-3">
          <div
            class="app-card p-4 text-center text-emerald-600 text-sm bg-emerald-50 border-emerald-100 font-bold shadow-none"
          >
            ‚ú® Tudo √≥timo! Sem estagna√ß√£o detetada.
          </div>
        </div>

        <!-- Add Entry Manual -->
        <div class="app-card p-6 mt-8 bg-slate-800 text-white">
          <h3 class="font-bold text-lg mb-4">Registo Manual de M√°ximo</h3>
          <form id="log-lift-form" class="space-y-4">
            <div>
              <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Exerc√≠cio</label>
              <select
                id="lift-select"
                class="w-full bg-slate-700 border-slate-600 text-white rounded-xl p-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none"
              >
                <option value="Incline DB Press">Supino Inclinado Halteres</option>
                <option value="Back Squat">Agachamento</option>
                <option value="Deadlift">Peso Morto</option>
                <option value="Weighted Dips">Fundos com Peso</option>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Peso (kg)</label>
                <input
                  type="number"
                  id="lift-weight"
                  placeholder="0"
                  class="w-full bg-slate-700 border-slate-600 text-white rounded-xl p-3 text-center font-bold focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                />
              </div>
              <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Reps</label>
                <input
                  type="number"
                  id="lift-reps"
                  placeholder="0"
                  class="w-full bg-slate-700 border-slate-600 text-white rounded-xl p-3 text-center font-bold focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                />
              </div>
            </div>
            <button
              type="submit"
              class="w-full bg-indigo-500 hover:bg-indigo-400 text-white font-bold py-3.5 rounded-xl shadow-lg transition-colors mt-2"
            >
              Guardar Registo
            </button>
          </form>
        </div>
      </section>
    </main>

    <!-- Bottom Navigation Bar (Glassmorphism) -->
    <nav
      class="fixed bottom-0 w-full bg-white/80 backdrop-blur-lg border-t border-slate-200 pb-[env(safe-area-inset-bottom)] z-50"
    >
      <div class="flex justify-around items-center h-[80px]">
        <button class="nav-item active flex flex-col items-center justify-center w-full h-full" data-target="dashboard">
          <span class="nav-icon">üè†</span>
          <span class="text-[10px] font-bold tracking-wide mt-1">In√≠cio</span>
        </button>
        <button class="nav-item flex flex-col items-center justify-center w-full h-full" data-target="log">
          <span class="nav-icon">üìù</span>
          <span class="text-[10px] font-bold tracking-wide mt-1">Di√°rio</span>
        </button>
        <button class="nav-item flex flex-col items-center justify-center w-full h-full" data-target="plans">
          <span class="nav-icon">üìã</span>
          <span class="text-[10px] font-bold tracking-wide mt-1">Planos</span>
        </button>
        <button class="nav-item flex flex-col items-center justify-center w-full h-full" data-target="nutrition">
          <span class="nav-icon">ü•ó</span>
          <span class="text-[10px] font-bold tracking-wide mt-1">Dieta</span>
        </button>
        <button class="nav-item flex flex-col items-center justify-center w-full h-full" data-target="progression">
          <span class="nav-icon">üìà</span>
          <span class="text-[10px] font-bold tracking-wide mt-1">Evolu√ß√£o</span>
        </button>
      </div>
    </nav>

    <!-- Timer Modal -->
    <div id="timer-modal" class="fixed inset-0 hidden z-[60] flex items-center justify-center p-6">
      <div
        class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl text-center transform transition-all scale-100 border border-slate-100"
      >
        <h3 class="text-lg font-bold mb-6 text-slate-800">Descanso</h3>
        <div id="timer-countdown" class="text-6xl font-black text-indigo-600 mb-8 font-mono tracking-tighter">
          00:00
        </div>
        <div class="grid grid-cols-3 gap-2 mb-6">
          <button
            onclick="setTimer(60)"
            class="bg-slate-50 border border-slate-200 py-3 rounded-xl font-bold text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors text-xs"
          >
            +60s
          </button>
          <button
            onclick="setTimer(90)"
            class="bg-slate-50 border border-slate-200 py-3 rounded-xl font-bold text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors text-xs"
          >
            +90s
          </button>
          <button
            onclick="setTimer(120)"
            class="bg-slate-50 border border-slate-200 py-3 rounded-xl font-bold text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition-colors text-xs"
          >
            +2m
          </button>
        </div>
        <div class="flex gap-3">
          <button
            onclick="toggleTimer()"
            id="timer-toggle-btn"
            class="flex-1 bg-indigo-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-200 active:scale-95 transition-transform"
          >
            Iniciar
          </button>
          <button
            onclick="closeTimer()"
            class="flex-1 bg-slate-100 text-slate-600 font-bold py-3.5 rounded-xl hover:bg-slate-200 transition-colors"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Plan Modal -->
    <div id="edit-plan-modal" class="fixed inset-0 hidden z-[70] flex items-end sm:items-center justify-center">
      <div
        class="bg-white w-full sm:max-w-lg h-[92vh] sm:h-auto sm:max-h-[90vh] sm:rounded-3xl rounded-t-3xl shadow-2xl flex flex-col"
      >
        <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-3xl shrink-0">
          <h3 class="font-bold text-xl text-slate-800">Editar Plano</h3>
          <button
            onclick="closeEditPlanModal()"
            class="bg-slate-100 text-slate-500 w-8 h-8 rounded-full flex items-center justify-center font-bold hover:bg-slate-200 transition-colors"
          >
            √ó
          </button>
        </div>

        <div class="p-5 flex-1 overflow-y-auto scroll-smooth" id="edit-plan-content">
          <!-- Injected via JS -->
        </div>

        <div class="p-5 border-t border-slate-100 bg-white pb-safe shrink-0 rounded-b-3xl">
          <button
            onclick="savePlanChanges()"
            class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-200 active:scale-95 transition-transform"
          >
            Guardar Altera√ß√µes
          </button>
        </div>
      </div>
    </div>

    <!-- Exercise Picker Modal -->
    <div id="exercise-modal" class="fixed inset-0 hidden z-[80] flex items-end sm:items-center justify-center">
      <div
        class="bg-white w-full sm:max-w-lg h-[85vh] sm:h-[600px] sm:rounded-3xl rounded-t-3xl shadow-2xl flex flex-col"
      >
        <div class="p-5 border-b border-slate-100 shrink-0 bg-white rounded-t-3xl">
          <h3 class="font-bold text-lg mb-3 text-slate-800">Selecionar Exerc√≠cio</h3>
          <input
            type="text"
            id="exercise-search"
            placeholder="Pesquisar..."
            class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-medium focus:ring-2 focus:ring-indigo-500 focus:outline-none"
            oninput="filterExercises()"
          />
        </div>
        <div class="flex-1 overflow-y-auto p-2" id="exercise-list">
          <!-- List injected here -->
        </div>
        <div class="p-5 border-t border-slate-100 pb-safe shrink-0">
          <button
            onclick="closeExerciseModal()"
            class="w-full bg-slate-100 text-slate-600 font-bold py-3.5 rounded-xl hover:bg-slate-200 transition-colors"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- CONSTANTS & DB (Translated) ---
      const EXERCISE_LIBRARY = {
        Peito: [
          "Supino Inclinado Halteres",
          "Supino Plano",
          "Fundos com Peso",
          "Aberturas (Cabo)",
          "Pec Deck",
          "Flex√µes",
          "Supino M√°quina",
        ],
        Costas: [
          "Eleva√ß√µes com Peso",
          "Puxada Alta (Lat Pulldown)",
          "Remada com Barra",
          "Remada no Cabo",
          "Peso Morto",
          "Face Pulls",
          "Remada T-Bar",
        ],
        Pernas: [
          "Agachamento (Back Squat)",
          "Leg Press",
          "Peso Morto Romeno (RDL)",
          "Agachamento B√∫lgaro",
          "Extens√£o de Pernas",
          "Curl de Pernas",
          "Eleva√ß√£o de G√©meos",
          "Afundos",
        ],
        Ombros: [
          "Press Militar (Barra)",
          "Press de Ombros (Halteres)",
          "Eleva√ß√µes Laterais",
          "Eleva√ß√µes Frontais",
          "Aberturas Inversas",
        ],
        Bra√ßos: [
          "Curl com Barra",
          "Curl Martelo",
          "Tricep na Polia",
          "Extens√£o Tricep (Cabo)",
          "Tricep √† Testa",
          "Curl Scott",
        ],
        Core: ["Crunch no Cabo", "Eleva√ß√£o de Pernas", "Prancha", "Roda Abdominal", "Russian Twist"],
      };

      const DEFAULT_PLAN = {
        id: "default_pb_pt",
        name: "Powerbuilding Padr√£o",
        days: [
          {
            title: "Superior A",
            subtitle: "Peito & Tricep",
            exercises: [
              { name: "Supino Inclinado Halteres", sets: 3, reps: "6-8" },
              { name: "Fundos com Peso", sets: 3, reps: "8-10" },
              { name: "Eleva√ß√µes com Peso", sets: 3, reps: "6-8" },
              { name: "Aberturas (Cabo)", sets: 3, reps: "12-15" },
              { name: "Extens√£o Tricep (Cabo)", sets: 3, reps: "12-15" },
              { name: "Curl Martelo", sets: 3, reps: "10-12" },
            ],
          },
          {
            title: "Inferior A",
            subtitle: "Cadeia Posterior",
            exercises: [
              { name: "Peso Morto Romeno (RDL)", sets: 3, reps: "8-10" },
              { name: "Leg Press", sets: 3, reps: "10-12" },
              { name: "Curl de Pernas", sets: 3, reps: "12-15" },
              { name: "Extens√£o de Pernas", sets: 3, reps: "12-15" },
              { name: "Eleva√ß√£o de G√©meos", sets: 4, reps: "10-15" },
              { name: "Crunch no Cabo", sets: 3, reps: "12-15" },
            ],
          },
          {
            title: "Superior B",
            subtitle: "Ombros & Volume",
            exercises: [
              { name: "Supino Plano", sets: 3, reps: "8-10" },
              { name: "Remada com Barra", sets: 3, reps: "10-12" },
              { name: "Press de Ombros (Halteres)", sets: 3, reps: "8-10" },
              { name: "Eleva√ß√µes Laterais", sets: 4, reps: "15-20" },
              { name: "Pec Deck", sets: 3, reps: "15" },
              { name: "Tricep na Polia", sets: 3, reps: "12-15" },
            ],
          },
          {
            title: "Inferior B",
            subtitle: "Foco Agachamento",
            exercises: [
              { name: "Peso Morto", sets: 1, reps: "5" },
              { name: "Agachamento (Back Squat)", sets: 3, reps: "5-8" },
              { name: "Agachamento B√∫lgaro", sets: 2, reps: "10" },
              { name: "Eleva√ß√£o de Pernas", sets: 3, reps: "10-15" },
              { name: "Eleva√ß√£o de G√©meos", sets: 4, reps: "15-20" },
            ],
          },
        ],
      };

      // --- STATE ---
      let allPlans = JSON.parse(localStorage.getItem("pb_allPlans")) || [DEFAULT_PLAN];
      let activePlanId = localStorage.getItem("pb_activePlanId") || DEFAULT_PLAN.id;
      let workoutLog = JSON.parse(localStorage.getItem("pb_workoutLog")) || {};

      let editingPlan = null;
      let activeDayIndexForEdit = null;
      let currentSuggestions = {};

      // --- AI LOGIC (Translated) ---
      function getAIRecommendation(savedSets, targetRepString, exerciseName) {
        if (!savedSets || savedSets.length === 0) return null;

        const target = parseInt(targetRepString.split("-")[1] || targetRepString);
        const minTarget = parseInt(targetRepString.split("-")[0] || targetRepString);

        let allHitMax = true;
        let anyFailed = false;

        savedSets.forEach((set) => {
          const r = parseInt(set.reps);
          if (isNaN(r)) return;
          if (r < target) allHitMax = false;
          if (r < minTarget) anyFailed = true;
        });

        const lastWeight = parseFloat(savedSets[0].weight);
        if (isNaN(lastWeight)) return null;

        // Check for big lifts using PT keywords
        const nameLower = exerciseName.toLowerCase();
        const isBigLift =
          nameLower.includes("agachamento") ||
          nameLower.includes("peso morto") ||
          nameLower.includes("terra") ||
          nameLower.includes("deadlift") ||
          nameLower.includes("squat");

        if (allHitMax && savedSets.length >= 2) {
          let increase = isBigLift ? 5 : 2.5;
          return {
            newWeight: lastWeight + increase,
            msg: `üöÄ Aumentar! Tenta ${lastWeight + increase}kg`,
            type: "increase",
            style: "prog-up",
          };
        }

        if (anyFailed) {
          const deload = Math.floor((lastWeight * 0.9) / 2.5) * 2.5;
          return {
            newWeight: deload,
            msg: `‚ö†Ô∏è Falha. Reduz para ${deload}kg`,
            type: "decrease",
            style: "prog-deload",
          };
        }

        return {
          newWeight: lastWeight,
          msg: `üî• Mant√©m ${lastWeight}kg`,
          type: "maintain",
          style: "prog-stall",
        };
      }

      function analyzeProgress() {
        const plan = getActivePlan();
        const nextTargets = [];
        const stalledLifts = [];
        const chartDataPoints = { Agachamento: [], "Peso Morto": [], Supino: [], Press: [] };

        const getLog = (dIdx, eIdx, sIdx) => {
          const base = `${plan.id}_d${dIdx}_e${eIdx}_s${sIdx}`;
          return { w: workoutLog[base + "_w"], r: workoutLog[base + "_r"] };
        };

        plan.days.forEach((day, dIdx) => {
          day.exercises.forEach((ex, eIdx) => {
            let setsData = [];
            for (let s = 0; s < ex.sets; s++) {
              const l = getLog(dIdx, eIdx, s);
              if (l.w && l.r) setsData.push({ weight: l.w, reps: l.r });
            }

            if (setsData.length > 0) {
              const rec = getAIRecommendation(setsData, ex.reps, ex.name);
              if (rec) {
                nextTargets.push({ name: ex.name, ...rec, lastW: setsData[0].weight });
                if (rec.type === "decrease") {
                  stalledLifts.push({ name: ex.name, msg: "Falha recente" });
                }
              }

              const name = ex.name.toLowerCase();
              let chartCat = null;
              if (name.includes("agachamento") && !name.includes("b√∫lgaro")) chartCat = "Agachamento";
              else if (name.includes("peso morto") && !name.includes("romeno")) chartCat = "Peso Morto";
              else if (name.includes("supino") || name.includes("bench")) chartCat = "Supino";
              else if (name.includes("militar") || name.includes("ombros")) chartCat = "Press";

              if (chartCat) {
                const est1RM = parseFloat(setsData[0].weight) * (1 + parseInt(setsData[0].reps) / 30);
                chartDataPoints[chartCat].push({ t: Date.now(), y: Math.round(est1RM) });
              }
            }
          });
        });

        return { nextTargets, stalledLifts, chartDataPoints };
      }

      // --- UI LOGIC ---
      function getActivePlan() {
        return allPlans.find((p) => p.id === activePlanId) || allPlans[0];
      }

      function savePlans() {
        localStorage.setItem("pb_allPlans", JSON.stringify(allPlans));
        localStorage.setItem("pb_activePlanId", activePlanId);
        renderDashboard();
        renderPlansList();
      }

      function renderDashboard() {
        const plan = getActivePlan();
        document.getElementById("active-plan-name").innerText = `Plano Ativo: ${plan.name}`;

        const grid = document.getElementById("dashboard-workouts-grid");
        grid.innerHTML = plan.days
          .map(
            (day, idx) => `
                <button onclick="startWorkout(${idx})" class="app-card p-5 text-left hover:shadow-lg transition-all active:scale-95 border border-slate-100">
                    <div class="text-3xl mb-3">${["üí™", "ü¶µ", "üìê", "‚ö°"][idx % 4]}</div>
                    <div class="font-bold text-slate-800 text-lg mb-1">${day.title}</div>
                    <div class="text-xs text-slate-500 font-medium truncate">${day.subtitle || day.exercises.length + " Exerc√≠cios"}</div>
                </button>
            `,
          )
          .join("");
      }

      function renderPlansList() {
        const container = document.getElementById("plans-list");
        container.innerHTML = allPlans
          .map(
            (plan) => `
                <div class="app-card p-5 flex justify-between items-center ${plan.id === activePlanId ? "border-2 border-indigo-500 bg-indigo-50/30" : ""}">
                    <div>
                        <div class="flex items-center gap-3 mb-1">
                            <h3 class="font-bold text-slate-800 text-lg">${plan.name}</h3>
                            ${plan.id === activePlanId ? '<span class="plan-active-badge">Ativo</span>' : ""}
                        </div>
                        <p class="text-xs text-slate-500 font-medium">${plan.days.length} Dias ‚Ä¢ ${plan.days.reduce((acc, d) => acc + d.exercises.length, 0)} Exerc√≠cios</p>
                    </div>
                    <div class="flex gap-2">
                        ${plan.id !== activePlanId ? `<button onclick="setActivePlan('${plan.id}')" class="text-xs bg-white border border-slate-200 px-4 py-2 rounded-xl font-bold text-slate-600 shadow-sm hover:bg-slate-50">Usar</button>` : ""}
                        <button onclick="openEditPlanModal('${plan.id}')" class="text-xs bg-indigo-100 text-indigo-700 px-4 py-2 rounded-xl font-bold hover:bg-indigo-200">Editar</button>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      function renderProgressionPage() {
        const data = analyzeProgress();

        const targetsContainer = document.getElementById("next-targets-list");
        if (data.nextTargets.length === 0) {
          targetsContainer.innerHTML =
            '<div class="text-center py-8 text-slate-400 text-sm italic bg-white rounded-2xl border border-dashed border-slate-200">Regista treinos para veres previs√µes.</div>';
        } else {
          targetsContainer.innerHTML = data.nextTargets
            .map(
              (t) => `
                    <div class="app-card p-4 flex justify-between items-center border-l-4 ${t.type === "increase" ? "border-emerald-500 bg-emerald-50/30" : t.type === "decrease" ? "border-red-400 bg-red-50/30" : "border-amber-400 bg-amber-50/30"}">
                        <div>
                            <div class="font-bold text-sm text-slate-800">${t.name}</div>
                            <div class="text-xs text-slate-500 font-medium mt-0.5">Anterior: ${t.lastW}kg</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-black text-slate-800 tracking-tight">${t.newWeight}<span class="text-xs font-bold ml-0.5 text-slate-400">kg</span></div>
                            <span class="prog-badge ${t.style} mt-1 inline-block">${t.type === "increase" ? "Subir Carga" : t.type === "decrease" ? "Deload" : "Manter"}</span>
                        </div>
                    </div>
                `,
            )
            .join("");
        }

        const stallContainer = document.getElementById("stall-watch-list");
        if (data.stalledLifts.length === 0) {
          stallContainer.innerHTML =
            '<div class="app-card p-4 text-center text-emerald-600 text-sm bg-emerald-50 font-bold border border-emerald-100 shadow-none">‚ú® Tudo limpo! Sem estagna√ß√£o.</div>';
        } else {
          stallContainer.innerHTML = data.stalledLifts
            .map(
              (s) => `
                    <div class="app-card p-4 bg-red-50 border border-red-100 flex items-center gap-4 shadow-none">
                        <span class="text-2xl">‚ö†Ô∏è</span>
                        <div>
                            <div class="font-bold text-red-800 text-sm">${s.name}</div>
                            <div class="text-xs text-red-600 font-medium mt-0.5">Recomenda√ß√£o: Reduzir 10%</div>
                        </div>
                    </div>
                `,
            )
            .join("");
        }

        const ctx = document.getElementById("progressionChart");
        if (ctx) {
          const chartStatus = Chart.getChart("progressionChart");
          if (chartStatus != undefined) {
            chartStatus.destroy();
          }

          const labels = Object.keys(data.chartDataPoints).filter((k) => data.chartDataPoints[k].length > 0);
          const values = labels.map((k) => data.chartDataPoints[k][0]?.y || 0);

          new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels.length ? labels : ["Sem Dados"],
              datasets: [
                {
                  label: "1RM Estimado (kg)",
                  data: values.length ? values : [0],
                  backgroundColor: ["#6366f1", "#8b5cf6", "#ec4899", "#10b981"],
                  borderRadius: 8,
                  barThickness: 40,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true, grid: { color: "#f1f5f9" }, ticks: { font: { family: "Inter" } } },
                x: { grid: { display: false }, ticks: { font: { family: "Inter", weight: "bold" } } },
              },
            },
          });
        }
      }

      function startWorkout(dayIdx) {
        const plan = getActivePlan();
        const day = plan.days[dayIdx];

        document.getElementById("workout-title").innerText = day.title;
        document.getElementById("workout-subtitle").innerText = day.subtitle || plan.name;

        currentSuggestions = {};
        let hasSuggestions = false;
        let html = "";

        day.exercises.forEach((ex, exIdx) => {
          const idBase = `${plan.id}_d${dayIdx}_e${exIdx}`;
          let setsHtml = "";
          let savedSetsData = [];

          for (let s = 0; s < ex.sets; s++) {
            const wKey = `${idBase}_s${s}_w`;
            const rKey = `${idBase}_s${s}_r`;
            const savedW = workoutLog[wKey] || "";
            const savedR = workoutLog[rKey] || "";

            if (savedW && savedR) savedSetsData.push({ weight: savedW, reps: savedR });

            setsHtml += `
                    <div class="flex gap-3 mb-3 items-center">
                        <div class="w-6 text-center font-bold text-slate-300 text-xs">${s + 1}</div>
                        <div class="flex-1 relative">
                            <input type="number" id="${wKey}" class="gym-input w-full p-3 text-slate-800" placeholder="0" value="${savedW}" oninput="saveLog('${wKey}', this.value)">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-slate-400 font-bold pointer-events-none">KG</span>
                        </div>
                        <div class="flex-1 relative">
                            <input type="number" id="${rKey}" class="gym-input w-full p-3 text-slate-800" placeholder="0" value="${savedR}" oninput="saveLog('${rKey}', this.value)">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-slate-400 font-bold pointer-events-none">REPS</span>
                        </div>
                    </div>`;
          }

          const rec = getAIRecommendation(savedSetsData, ex.reps, ex.name);
          let badgeHtml = "";

          if (rec && rec.type === "increase") {
            hasSuggestions = true;
            for (let s = 0; s < ex.sets; s++) {
              currentSuggestions[`${idBase}_s${s}_w`] = rec.newWeight;
            }
            badgeHtml = `<div class="mt-3 ${rec.style} text-xs p-3 rounded-xl flex items-center gap-2 ai-pulse border border-emerald-200/50 font-bold shadow-sm">${rec.msg}</div>`;
          } else if (rec) {
            badgeHtml = `<div class="mt-3 ${rec.style} text-xs p-3 rounded-xl flex items-center gap-2 border border-slate-100 font-bold">${rec.msg}</div>`;
          }

          html += `
                <div class="app-card p-5 border-l-4 border-indigo-500">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="font-bold text-slate-800 text-lg">${ex.name}</h4>
                            <div class="flex gap-2 mt-1">
                                <span class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded-md font-bold uppercase tracking-wide">${ex.sets} S√©ries</span>
                                <span class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded-md font-bold uppercase tracking-wide">${ex.reps} Reps</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex text-[9px] uppercase font-bold text-slate-400 mb-2 px-1 tracking-wider">
                        <span class="w-6 text-center">#</span>
                        <span class="flex-1 text-center">Carga</span>
                        <span class="flex-1 text-center">Reps</span>
                    </div>

                    ${setsHtml}
                    ${badgeHtml}
                </div>`;
        });

        const banner = document.getElementById("ai-coach-banner");
        if (hasSuggestions) {
          banner.classList.remove("hidden");
          banner.classList.add("flex");
        } else {
          banner.classList.add("hidden");
          banner.classList.remove("flex");
        }

        html += `<div class="pb-12 pt-4"><button onclick="finishWorkout()" class="w-full bg-emerald-500 hover:bg-emerald-400 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-200 active:scale-95 transition-all flex items-center justify-center gap-2 text-lg"><span>‚úÖ</span> Concluir Treino</button></div>`;

        document.getElementById("workout-exercises").innerHTML = html;
        switchTab("log");
      }

      function saveLog(key, val) {
        workoutLog[key] = val;
        localStorage.setItem("pb_workoutLog", JSON.stringify(workoutLog));
      }

      function applyAISuggestions() {
        for (const [key, value] of Object.entries(currentSuggestions)) {
          const el = document.getElementById(key);
          if (el) {
            el.value = value;
            el.classList.add("bg-purple-50", "text-purple-700", "border-purple-200");
            saveLog(key, value);
            const rKey = key.replace("_w", "_r");
            const rEl = document.getElementById(rKey);
            if (rEl) {
              rEl.value = "";
              saveLog(rKey, "");
            }
          }
        }
        alert("‚ú® Pesos atualizados para sobrecarga progressiva!");
        document.getElementById("ai-coach-banner").classList.add("hidden");
      }

      // --- EDIT & HELPERS ---
      function setActivePlan(id) {
        activePlanId = id;
        savePlans();
        alert("Plano Ativado!");
      }
      function createNewPlan() {
        const newId = "plan_" + Date.now();
        allPlans.push({ id: newId, name: "Novo Plano", days: [{ title: "Dia 1", subtitle: "Foco", exercises: [] }] });
        savePlans();
        openEditPlanModal(newId);
      }
      function openEditPlanModal(id) {
        editingPlan = JSON.parse(JSON.stringify(allPlans.find((p) => p.id === id)));
        renderEditModalContent();
        document.getElementById("edit-plan-modal").classList.remove("hidden");
      }
      function renderEditModalContent() {
        const container = document.getElementById("edit-plan-content");
        let html = `<div class="mb-8"><label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">Nome do Plano</label><input type="text" value="${editingPlan.name}" oninput="editingPlan.name = this.value" class="w-full gym-input p-4 text-left bg-white border-slate-200 text-slate-800 text-lg"></div><div class="space-y-8">`;
        editingPlan.days.forEach((day, dayIdx) => {
          html += `<div class="border border-slate-100 rounded-3xl p-5 bg-slate-50/50 shadow-sm"><div class="flex gap-3 mb-4"><input type="text" value="${day.title}" onchange="updateDayTitle(${dayIdx}, this.value)" class="flex-1 font-bold bg-transparent border-b-2 border-slate-200 focus:border-indigo-500 focus:outline-none py-1 text-slate-800" placeholder="T√≠tulo do Dia"><input type="text" value="${day.subtitle || ""}" onchange="updateDaySubtitle(${dayIdx}, this.value)" class="flex-1 text-sm text-slate-500 bg-transparent border-b-2 border-slate-200 focus:border-indigo-500 focus:outline-none py-1" placeholder="Subt√≠tulo"><button onclick="removeDay(${dayIdx})" class="text-red-400 hover:text-red-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition-colors">üóëÔ∏è</button></div><div class="space-y-3 mb-4">${day.exercises.map((ex, exIdx) => `<div class="flex items-center justify-between bg-white p-3 rounded-xl shadow-sm border border-slate-100"><span class="text-sm font-bold text-slate-700">${ex.name}</span><div class="flex items-center gap-2"><input type="number" value="${ex.sets}" class="w-10 text-center bg-slate-50 rounded-lg text-xs p-1.5 font-bold border border-slate-100" onchange="updateEx(${dayIdx}, ${exIdx}, 'sets', this.value)"><span class="text-[10px] text-slate-400 font-bold">X</span><input type="text" value="${ex.reps}" class="w-14 text-center bg-slate-50 rounded-lg text-xs p-1.5 font-bold border border-slate-100" onchange="updateEx(${dayIdx}, ${exIdx}, 'reps', this.value)"><button onclick="removeEx(${dayIdx}, ${exIdx})" class="text-slate-300 hover:text-red-500 ml-2 text-lg">√ó</button></div></div>`).join("")}</div><button onclick="openExercisePicker(${dayIdx})" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 text-sm font-bold hover:bg-indigo-50 hover:border-indigo-300 hover:text-indigo-600 transition-all">+ Adicionar Exerc√≠cio</button></div>`;
        });
        html += `</div><button onclick="addDayToEdit()" class="mt-8 w-full py-4 bg-slate-100 rounded-2xl font-bold text-slate-600 hover:bg-slate-200 transition-colors">+ Adicionar Dia de Treino</button><button onclick="deletePlan()" class="mt-4 w-full py-4 text-red-400 text-xs font-bold hover:text-red-600 uppercase tracking-wider">Apagar Plano</button>`;
        container.innerHTML = html;
      }
      function updateDayTitle(idx, v) {
        editingPlan.days[idx].title = v;
      }
      function updateDaySubtitle(idx, v) {
        editingPlan.days[idx].subtitle = v;
      }
      function updateEx(dIdx, eIdx, f, v) {
        editingPlan.days[dIdx].exercises[eIdx][f] = v;
      }
      function removeDay(idx) {
        editingPlan.days.splice(idx, 1);
        renderEditModalContent();
      }
      function removeEx(dIdx, eIdx) {
        editingPlan.days[dIdx].exercises.splice(eIdx, 1);
        renderEditModalContent();
      }
      function addDayToEdit() {
        editingPlan.days.push({ title: "Novo Dia", subtitle: "", exercises: [] });
        renderEditModalContent();
      }
      function deletePlan() {
        if (confirm("Apagar este plano permanentemente?")) {
          allPlans = allPlans.filter((p) => p.id !== editingPlan.id);
          if (activePlanId === editingPlan.id) activePlanId = allPlans[0]?.id;
          savePlans();
          closeEditPlanModal();
        }
      }
      function savePlanChanges() {
        const idx = allPlans.findIndex((p) => p.id === editingPlan.id);
        if (idx !== -1) allPlans[idx] = editingPlan;
        savePlans();
        closeEditPlanModal();
      }
      function closeEditPlanModal() {
        document.getElementById("edit-plan-modal").classList.add("hidden");
      }
      function openExercisePicker(dIdx) {
        activeDayIndexForEdit = dIdx;
        renderExerciseList("");
        document.getElementById("exercise-modal").classList.remove("hidden");
      }
      function closeExerciseModal() {
        document.getElementById("exercise-modal").classList.add("hidden");
      }
      function filterExercises() {
        renderExerciseList(document.getElementById("exercise-search").value);
      }
      function selectExercise(name) {
        editingPlan.days[activeDayIndexForEdit].exercises.push({ name: name, sets: 3, reps: "8-12" });
        renderEditModalContent();
        closeExerciseModal();
      }

      function renderExerciseList(filter) {
        const list = document.getElementById("exercise-list");
        let html = "";
        // Add custom option if searching
        if (filter.length > 2) {
          html += `<button onclick="selectExercise('${filter}')" class="w-full text-left p-4 bg-indigo-50 mb-3 rounded-2xl font-bold text-indigo-600 hover:bg-indigo-100 transition-colors border border-indigo-100 shadow-sm flex items-center gap-2"><span>‚ûï</span> Adicionar "${filter}"</button>`;
        }

        for (const [cat, exs] of Object.entries(EXERCISE_LIBRARY)) {
          const filtered = exs.filter((e) => e.toLowerCase().includes(filter.toLowerCase()));
          if (filtered.length) {
            html +=
              `<div class="font-bold text-slate-400 text-[10px] uppercase mt-6 mb-3 px-2 tracking-widest">${cat}</div>` +
              filtered
                .map(
                  (e) =>
                    `<button onclick="selectExercise('${e}')" class="w-full text-left p-4 bg-slate-50 mb-2 rounded-2xl font-medium text-slate-700 hover:bg-white hover:shadow-md hover:text-indigo-600 transition-all border border-transparent hover:border-slate-100">${e}</button>`,
                )
                .join("");
          }
        }
        list.innerHTML = html;
      }

      function finishWorkout() {
        if (confirm("Treino Conclu√≠do? Bom trabalho!")) switchTab("dashboard");
      }

      // --- INIT & CHARTS (Chart Logic + Init) ---
      const navItems = document.querySelectorAll(".nav-item");
      const pages = document.querySelectorAll(".page-content");
      function switchTab(targetId) {
        navItems.forEach((i) => i.classList.toggle("active", i.dataset.target === targetId));
        pages.forEach((p) => p.classList.toggle("active", p.id === targetId));
        if (targetId === "plans") renderPlansList();
        if (targetId === "dashboard") renderDashboard();
        if (targetId === "progression") renderProgressionPage();
        if (targetId === "nutrition") renderNutritionChart();
        window.scrollTo(0, 0);
      }
      navItems.forEach((i) => i.addEventListener("click", () => switchTab(i.dataset.target)));

      let chartInstanceNutrition;
      function renderNutritionChart() {
        const ctx = document.getElementById("nutritionChart");
        if (!ctx || chartInstanceNutrition) return;
        chartInstanceNutrition = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Prot", "Carb", "Gord"],
            datasets: [
              {
                data: [640, 1400, 630],
                backgroundColor: ["#4f46e5", "#eab308", "#ef4444"],
                borderWidth: 0,
                hoverOffset: 10,
              },
            ],
          },
          options: {
            cutout: "85%",
            plugins: { legend: { display: false } },
            responsive: true,
            maintainAspectRatio: false,
            animation: { animateScale: true, animateRotate: true },
          },
        });
      }

      // Timer Logic
      let timerInterval,
        timeLeft = 0;
      const display = document.getElementById("timer-display");
      const mDisplay = document.getElementById("timer-countdown");
      document
        .getElementById("timer-btn")
        .addEventListener("click", () => document.getElementById("timer-modal").classList.remove("hidden"));
      function closeTimer() {
        document.getElementById("timer-modal").classList.add("hidden");
      }
      function setTimer(s) {
        timeLeft = s;
        if (!timerInterval) startTimer();
      }
      function toggleTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        } else startTimer();
      }
      function startTimer() {
        timerInterval = setInterval(() => {
          timeLeft--;
          const m = Math.floor(timeLeft / 60)
              .toString()
              .padStart(2, "0"),
            s = (timeLeft % 60).toString().padStart(2, "0");
          display.innerText = timeLeft > 0 ? `${m}:${s}` : "Descanso";
          mDisplay.innerText = `${m}:${s}`;
          if (timeLeft <= 0) clearInterval(timerInterval);
        }, 1000);
      }

      renderDashboard();
    </script>
  </body>
</html>
